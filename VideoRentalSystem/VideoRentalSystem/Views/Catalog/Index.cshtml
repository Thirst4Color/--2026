@using VideoRentalSystem.Extensions
@model List<VideoRentalSystem.Models.ViewModels.MovieViewModel>
@{
    ViewData["Title"] = "Каталог фильмов - Видеопрокат";
    Layout = "_Layout";

    // Получаем значения фильтров из ViewData
    var searchValue = ViewData["Search"] as string ?? "";
    var selectedGenre = ViewData["SelectedGenre"] as string ?? "";
    var selectedFormat = ViewData["SelectedFormat"] as string ?? "";
    var genres = ViewData["Genres"] as List<string> ?? new List<string>();
    var formats = ViewData["Formats"] as List<string> ?? new List<string>();
}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4">🎬 Каталог фильмов</h1>
            <p class="lead">Выбирайте фильмы из нашей коллекции и заказывайте онлайн</p>
        </div>
    </div>

    <!-- Поиск и фильтры -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-6">
                    <input type="text" name="search" class="form-control"
                           placeholder="Поиск по названию, режиссеру, жанру..."
                           value="@searchValue"
                           id="searchInput" />
                </div>
                <div class="col-md-3">
                    <select name="genre" class="form-select">
                        <option value="">Все жанры</option>
                        @foreach (var genre in genres)
                        {
                            if (!string.IsNullOrEmpty(genre))
                            {
                                <option value="@genre" selected="@(genre == selectedGenre)">
                                    @genre
                                </option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="format" class="form-select">
                        <option value="">Все форматы</option>
                        @foreach (var format in formats)
                        {
                            if (!string.IsNullOrEmpty(format))
                            {
                                <option value="@format" selected="@(format == selectedFormat)">
                                    @format
                                </option>
                            }
                        }
                    </select>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Найти
                    </button>
                    @if (!string.IsNullOrEmpty(searchValue) || !string.IsNullOrEmpty(selectedGenre) || !string.IsNullOrEmpty(selectedFormat))
                    {
                        <a href="@Url.Action("Index")" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Сбросить фильтры
                        </a>
                    }
                </div>
            </form>

            <!-- Показать активные фильтры -->
            @if (!string.IsNullOrEmpty(searchValue) || !string.IsNullOrEmpty(selectedGenre) || !string.IsNullOrEmpty(selectedFormat))
            {
                <div class="mt-3">
                    <small class="text-muted">
                        Активные фильтры:
                        @if (!string.IsNullOrEmpty(searchValue))
                        {
                            <span class="badge bg-info">Поиск: "@searchValue"</span>
                        }
                        @if (!string.IsNullOrEmpty(selectedGenre))
                        {
                            <span class="badge bg-info">Жанр: "@selectedGenre"</span>
                        }
                        @if (!string.IsNullOrEmpty(selectedFormat))
                        {
                            <span class="badge bg-info">Формат: "@selectedFormat"</span>
                        }
                    </small>
                </div>
            }
        </div>
    </div>


    <!-- Карточки фильмов -->
    @if (Model.Any())
    {
        <div class="row">
            @foreach (var movie in Model)
            {
                <div class="col-md-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="position-relative">
                            <img src="@movie.CoverImageUrl" class="card-img-top" alt="@movie.Title" 
                                 style="height: 300px; object-fit: cover;"
                                 onerror="this.src='/images/default-movie.jpg'">
                            @if (movie.Rating.HasValue)
                            {
                                <div class="position-absolute top-0 end-0 m-2 bg-warning text-dark rounded-circle p-2" 
                                     style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                    <strong>@movie.Rating.Value.ToString("0.0")</strong>
                                </div>
                            }
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@movie.Title @(movie.Year.HasValue ? $"({movie.Year})" : "")</h5>
                            <p class="card-text text-muted">@movie.Genre</p>
                            <p class="card-text flex-grow-1">@movie.Description</p>
                            
                            <!-- Информация о доступности -->
                            <div class="mt-auto">
                                @if (movie.MediaItems != null && movie.MediaItems.Any(mi => mi.IsAvailable))
                                {
                                    var firstAvailableMediaItem = movie.MediaItems.FirstOrDefault(mi => mi.IsAvailable);
                                    if (firstAvailableMediaItem != null)
                                    {
                                        <form method="post" action="/Cart/AddToCart" class="d-inline">
                                            <input type="hidden" name="mediaItemId" value="@firstAvailableMediaItem.MediaItemId" />
                                            <button type="submit" class="btn btn-success btn-sm">В корзину</button>
                                        </form>
                                    }
                                }
                                
                                <!-- Кнопки действий -->
                                <div class="card-footer">
                                    <a href="/Catalog/Details/@movie.MovieId" class="btn btn-primary btn-sm">Подробнее</a>

                                    @if (movie.IsAvailable)
                                    {
                                        <form method="post" action="/Cart/AddToCart" class="d-inline">
                                            @{
                                                var firstAvailableMediaItem = movie.MediaItems?.FirstOrDefault(mi => mi.IsAvailable);
                                            }
                                            @if (firstAvailableMediaItem != null)
                                            {
                                                <input type="hidden" name="mediaItemId" value="@firstAvailableMediaItem.MediaItemId" />
                                                <button type="submit" class="btn btn-success btn-sm">В корзину</button>
                                            }
                                        </form>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        <!-- Информация о количестве найденных фильмов -->
        <div class="alert alert-info">
            Найдено фильмов: <strong>@Model.Count</strong>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <h4 class="alert-heading">Фильмы не найдены</h4>
            <p>Попробуйте изменить параметры поиска или <a href="@Url.Action("Index")">сбросить фильтры</a>.</p>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Автодополнение поиска
        $(function() {
            $("#searchInput").autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: '@Url.Action("Search", "Catalog")',
                        dataType: "json",
                        data: {
                            term: request.term
                        },
                        success: function(data) {
                            response($.map(data, function(item) {
                                return {
                                    label: item.text + (item.year ? ' (' + item.year + ')' : ''),
                                    value: item.text,
                                    id: item.id
                                };
                            }));
                        }
                    });
                },
                minLength: 2,
                select: function(event, ui) {
                    window.location.href = '@Url.Action("Details", "Catalog")/' + ui.item.id;
                }
            }).autocomplete("instance")._renderItem = function(ul, item) {
                return $("<li>")
                    .append("<div>" + item.label + "<br><small>" + (item.genre || '') + "</small></div>")
                    .appendTo(ul);
            };
        });

        
    </script>
}